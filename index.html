<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Packers Win Probability by Week</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    .week-container { margin-bottom: 3em; }
    .excitingness { font-weight: bold; margin-bottom: 0.5em; }
    canvas { background: #f8f8f8; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Win Probability by Week</h1>
  <div style="max-width:800px;margin-bottom:2em;font-size:1.1em;line-height:1.5;">
    Win Probability was calculated by averaging the absolute value of .5 - the home Team win probability. The closer and more exciting the game is, the closer this value will be to 0. Week 11 has the lowest value and was therefore the most exciting.
  </div>
  <div id="weeks"></div>
  <script>
    async function fetchData() {
      const [wpRes, excitingRes] = await Promise.all([
        fetch('wp.json'),
        fetch('exciting.csv')
      ]);
      // Parse wp.json as JSON Lines
      const wpText = await wpRes.text();
      const wpData = wpText.trim().split('\n').map(line => JSON.parse(line));
      const excitingText = await excitingRes.text();
      const exciting = parseExcitingCSV(excitingText);
      return { wpData, exciting };
    }

    function parseExcitingCSV(csv) {
      const lines = csv.trim().split('\n');
      const header = lines[0].split(',');
      return lines.slice(1).map(line => {
        const obj = {};
        line.split(',').forEach((val, i) => {
          obj[header[i]] = val;
        });
        return obj;
      });
    }

    function groupByWeek(wpData) {
      const byWeek = {};
      wpData.forEach(row => {
        const week = row.week || row["week"];
        if (!byWeek[week]) byWeek[week] = [];
        byWeek[week].push(row);
      });
      return byWeek;
    }

    function drawGraph(canvas, data) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);

      // Axes
      ctx.strokeStyle = '#333';
      ctx.beginPath();
      ctx.moveTo(40, 10);
      ctx.lineTo(40, height-30);
      ctx.lineTo(width-10, height-30);
      ctx.stroke();

      // X axis label and ticks (0 to 60)
      ctx.font = '12px Arial';
      ctx.fillStyle = '#333';
      for (let t = 0; t <= 60; t += 10) {
        const x = 40 + (t/60)*(width-60);
        ctx.fillText(t, x-8, height-10);
        ctx.beginPath();
        ctx.moveTo(x, height-30);
        ctx.lineTo(x, height-25);
        ctx.stroke();
      }
      ctx.fillText('Game Time (min)', width/2-40, height);

      // Y axis label and ticks (0 to 100)
      for (let p = 0; p <= 100; p += 20) {
        const y = height-30 - (p/100)*(height-40);
        ctx.fillText(p, 5, y+4);
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(35, y);
        ctx.stroke();
      }
      ctx.save();
      ctx.translate(0, height/2+30);
      ctx.rotate(-Math.PI/2);
      ctx.fillText('Win Probability (%)', 0, 15);
      ctx.restore();

      // Data
      ctx.strokeStyle = '#0074D9';
      ctx.beginPath();
      data.forEach((d, i) => {
        const x = 40 + ((parseFloat(d.game_time))/60)*(width-60);
        const y = height-30 - ((parseFloat(d.wp_post))*100/100)*(height-40);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function render(byWeek, exciting) {
      const weeksDiv = document.getElementById('weeks');
      Object.keys(byWeek).forEach(week => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'week-container';
        // Highlight week 11
        if (String(week) === '11') {
          weekDiv.style.border = '3px solid #e74c3c';
          weekDiv.style.background = '#fff3f0';
        }
        const exc = exciting.find(e => e.week === String(week));
        let label = `<div class=\"excitingness\">Week ${week} Excitingness: ${exc ? exc.excitingness : 'N/A'}`;
        if (String(week) === '11') label += ' <span style="color:#e74c3c">(Most Exciting Game!)</span>';
        label += '</div>';
        weekDiv.innerHTML = label;
        const canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 300;
        weekDiv.appendChild(canvas);
        weeksDiv.appendChild(weekDiv);
        drawGraph(canvas, byWeek[week]);
      });
    }

    fetchData().then(({wpData, exciting}) => {
      const byWeek = groupByWeek(wpData);
      render(byWeek, exciting);
    });
  </script>
</body>
</html>
